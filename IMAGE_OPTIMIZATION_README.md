# การปรับปรุงระบบจัดการรูปภาพสำหรับ Telegram

## ปัญหาที่แก้ไข
- Telegram ไม่สามารถรับไฟล์รูปภาพ PNG ที่เข้ารหัสหรือมีขนาดใหญ่เกินไป
- ไฟล์รูปภาพที่อัปโหลดมีขนาดใหญ่เกินขีดจำกัดของ Telegram (10MB)
- ไม่มีการปรับขนาดรูปภาพก่อนส่งไป Telegram

## การแก้ไขที่ทำ

### 1. เพิ่ม Image Processing Library
```bash
go get github.com/nfnt/resize
```

### 2. สร้างไฟล์ `handlers/common/imageProcessor.go`
ฟีเจอร์หลัก:
- **ลดขนาดรูปภาพ**: ปรับขนาดรูปภาพให้ไม่เกิน 1920x1080 pixels
- **บีบอัดรูปภาพ**: ลดคุณภาพ JPEG เป็น 85% (ปรับได้)
- **แปลง PNG เป็น JPEG**: สำหรับรูปภาพที่ไม่ต้องการความโปร่งใส
- **จำกัดขนาดไฟล์**: ไม่เกิน 10MB ตามข้อจำกัดของ Telegram
- **ปรับคุณภาพอัตโนมัติ**: ลดคุณภาพ JPEG หากไฟล์ยังใหญ่เกินไป

### 3. อัปเดต `handlers/common/minioService.go`
- เพิ่มการประมวลผลรูปภาพก่อนอัปโหลดไป MinIO
- ตรวจสอบประเภทไฟล์ (รองรับเฉพาะ .jpg, .jpeg, .png)
- อัปเดตชื่อไฟล์หากมีการแปลงรูปแบบ (PNG → JPEG)

### 4. อัปเดต `handlers/common/telegramService.go`
- เพิ่มการประมวลผลรูปภาพที่ดาวน์โหลดมาก่อนส่งไป Telegram
- ใช้ `ProcessImageFromReader` สำหรับรูปภาพที่ดาวน์โหลดจาก URL
- ปรับปรุงฟังก์ชัน `sendPhotoMessage` และ `ReplyToSpecificMessage`

## การกำหนดค่า

### ค่าเริ่มต้น (DefaultImageConfig)
```go
ImageConfig{
    MaxWidth:    1920,              // ความกว้างสูงสุด
    MaxHeight:   1080,              // ความสูงสูงสุด  
    Quality:     85,                // คุณภาพ JPEG (1-100)
    MaxFileSize: 10 * 1024 * 1024,  // ขนาดไฟล์สูงสุด 10MB
}
```

### การปรับแต่งค่า
สามารถปรับค่าได้ตามต้องการ:
```go
customConfig := ImageConfig{
    MaxWidth:    1280,
    MaxHeight:   720,
    Quality:     75,
    MaxFileSize: 5 * 1024 * 1024, // 5MB
}
```

## ประโยชน์ที่ได้รับ

1. **ส่งรูปภาพไป Telegram ได้สำเร็จ**: ไม่มีปัญหาไฟล์ใหญ่เกินไปหรือรูปแบบไม่รองรับ
2. **ประหยัดพื้นที่จัดเก็บ**: รูปภาพมีขนาดเล็กลงแต่คุณภาพยังดี
3. **ส่งข้อมูลเร็วขึ้น**: ไฟล์เล็กลงทำให้อัปโหลดและดาวน์โหลดเร็วขึ้น
4. **รองรับรูปแบบที่หลากหลาย**: แปลง PNG เป็น JPEG อัตโนมัติเมื่อเหมาะสม
5. **ปรับขนาดอัตโนมัติ**: รักษาอัตราส่วนภาพเดิมขณะลดขนาด

## การทำงานของระบบ

### สำหรับการอัปโหลดไฟล์ใหม่:
1. ตรวจสอบประเภทไฟล์
2. ประมวลผลรูปภาพ (ปรับขนาด + บีบอัด)
3. อัปโหลดไป MinIO
4. ส่งไป Telegram

### สำหรับรูปภาพที่ดาวน์โหลดจาก URL:
1. ดาวน์โหลดรูปภาพจาก URL
2. ประมวลผลรูปภาพ (ปรับขนาด + บีบอัด)
3. ส่งไป Telegram

## Log Messages
ระบบจะแสดง log เพื่อติดตามการทำงาน:
- `Original image dimensions: 2048x1536`
- `Resizing image to: 1920x1080`
- `Converted PNG to JPEG for better compression. Size: 245760 bytes`
- `Image processing completed. Final size: 245760 bytes, Content-Type: image/jpeg`

## การจัดการข้อผิดพลาด
- หากประมวลผลรูปภาพไม่สำเร็จ จะส่งเป็นข้อความแทน
- หากไฟล์ไม่ใช่รูปภาพ จะข้ามการประมวลผล
- หากส่งรูปภาพไป Telegram ไม่สำเร็จ จะส่งเป็นข้อความแทน

## ข้อจำกัด
- รองรับเฉพาะไฟล์ .jpg, .jpeg, .png
- ไฟล์ที่มีขนาดใหญ่มากอาจใช้เวลาในการประมวลผล
- การแปลง PNG เป็น JPEG จะทำให้สูญเสียความโปร่งใส (transparency)